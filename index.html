<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Buddy - AI Question Solver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f3f4f6;
            background-image: linear-gradient(to top, #f3f4f6 0%, #e5e7eb 100%);
        }
        .container-main { flex-grow: 1; }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        #cameraView { max-width: 100%; border-radius: 0.5rem; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 0.75rem; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { transition: all 0.2s ease-in-out; }

        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 9999px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show { bottom: 30px; }
        #toast.success { background-color: #28a745; }
        #toast.error { background-color: #dc3545; }

        .selection-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .selection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="toast"></div>

    <div id="appContainer">

        <!-- LOGIN PAGE -->
        <div id="loginPage" class="page min-h-screen flex items-center justify-center bg-gray-100 p-4">
             <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">Welcome Back!</h2>
                    <p class="text-gray-500 mt-2">Sign in to continue</p>
                </div>
                <div class="space-y-4">
                    <input id="loginEmail" type="email" placeholder="Email " class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input id="loginPassword" type="password" placeholder="Password " class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="loginBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg">Login</button>
                    <p class="text-center text-sm text-gray-600 pt-2">
                        Don't have an account? <a href="#" id="showSignup" class="font-medium text-blue-600 hover:underline">Sign up</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- SIGNUP PAGE -->
        <div id="signupPage" class="page hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
                 <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">Create Account</h2>
                    <p class="text-gray-500 mt-2">Get started with your study buddy</p>
                </div>
                <div class="space-y-4">
                    <input id="signupName" type="text" placeholder="Full Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input id="signupEmail" type="email" placeholder="Email Address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input id="signupPassword" type="password" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="signupBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg">Sign Up</button>
                    <p class="text-center text-sm text-gray-600 pt-2">
                        Already have an account? <a href="#" id="showLogin" class="font-medium text-blue-600 hover:underline">Login</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- USER SETUP PAGE with Cards -->
        <div id="setupPage" class="page hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">Welcome, <span id="setupUserName"></span>!</h2>
                    <p class="text-gray-500 mt-2">Let's personalize your experience. What is your primary focus?</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                    <div id="schoolCard" class="selection-card cursor-pointer bg-blue-500 text-white p-6 rounded-xl flex flex-col items-center justify-center text-center">
                        <h3 class="font-bold text-xl">School</h3>
                        <p class="text-sm mt-1">Class 10-12</p>
                    </div>
                    <div id="examCard" class="selection-card cursor-pointer bg-green-500 text-white p-6 rounded-xl flex flex-col items-center justify-center text-center">
                        <h3 class="font-bold text-xl">Competitive Exams</h3>
                        <p class="text-sm mt-1">JEE / NEET</p>
                    </div>
                    <div id="collegeCard" class="selection-card cursor-pointer bg-indigo-500 text-white p-6 rounded-xl flex flex-col items-center justify-center text-center">
                        <h3 class="font-bold text-xl">College</h3>
                        <p class="text-sm mt-1">B.Tech, BCA etc.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- College Course Selection Modal -->
        <div id="collegeCourseModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md space-y-6">
                <h2 class="text-2xl font-bold text-gray-900 text-center">Select Your Course</h2>
                <div id="courseSelectionContainer" class="grid grid-cols-2 gap-4">
                    <button data-course="B.Tech CSE" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">B.Tech CSE</button>
                    <button data-course="B.Tech ECE" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">B.Tech ECE</button>
                    <button data-course="BCA" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">BCA</button>
                    <button data-course="BBA" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">BBA</button>
                    <button data-course="B.Sc" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">B.Sc</button>
                    <button data-course="Other" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">Other</button>
                </div>
            </div>
        </div>

        <!-- MAIN APP PAGE -->
        <div id="mainAppPage" class="page hidden">
            <div id="cameraModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 z-50 hidden">
                <video id="cameraView" autoplay playsinline class="mb-4"></video>
                <canvas id="cameraCanvas" class="hidden"></canvas>
                <div class="flex space-x-4">
                    <button id="captureBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700">Capture</button>
                    <button id="closeCameraBtn" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-700">Close</button>
                </div>
            </div>

            <div class="container-main mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
                <header class="mb-8">
                    <nav class="bg-white rounded-full shadow-xl p-3 flex items-center justify-between">
                        <div class="flex items-center space-x-3 ml-2">
                             <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18-3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0 0v14.25" />
                            </svg>
                            <h1 class="text-xl font-bold text-gray-800 hidden sm:block">Study Buddy</h1>
                        </div>
                        <div class="flex items-center space-x-2">
                             <button id="examNavBtn" class="text-gray-700 font-semibold py-2 px-5 rounded-full hover:bg-gray-100 transition">Exams</button>
                             <button id="quizNavBtn" class="text-gray-700 font-semibold py-2 px-5 rounded-full hover:bg-gray-100 transition">Quizzes</button>
                             <button id="profileBtn" class="text-gray-700 font-semibold py-2 px-5 rounded-full hover:bg-gray-100 transition">Profile</button>
                             <button id="logoutBtn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-full hover:bg-red-600 transition shadow-md">Logout</button>
                        </div>
                    </nav>
                </header>

                <main>
                    <div id="announcementsContainer" class="mb-8 space-y-4"></div>
                    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
                        <div class="flex border-b border-gray-200 mb-6">
                            <button id="scanTab" class="py-3 px-4 font-semibold text-blue-600 border-b-2 border-blue-600 focus:outline-none w-1/2 text-center transition-colors">Scan</button>
                            <button id="typeTab" class="py-3 px-4 font-semibold text-gray-500 focus:outline-none w-1/2 text-center transition-colors hover:text-blue-500">Type</button>
                        </div>
                        <div id="scanContent" class="tab-content">
                            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Upload Your Question</h2>
                            <div class="relative w-full">
                                <input type="file" id="questionScanner" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*">
                                <div id="file-display" class="flex items-center justify-center w-full h-32 sm:h-40 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors">
                                    <div class="text-center px-2">
                                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                        <p id="file-text" class="mt-2 text-sm text-gray-600 truncate">Click to upload an image</p>
                                    </div>
                                </div>
                            </div>
                            <button id="openCameraBtn" class="w-full mt-4 bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 transition-all duration-300 transform hover:scale-105 shadow-md">Scan with Camera</button>
                        </div>
                        <div id="typeContent" class="hidden tab-content">
                            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Enter Your Question</h2>
                            <textarea id="manualQuestion" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="Type your question here..."></textarea>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">Answer Length</h3>
                            <div class="flex justify-center space-x-4 sm:space-x-8 bg-gray-50 p-3 rounded-lg">
                                <div class="flex items-center"><input id="shortAnswerOption" type="radio" name="answerLength" value="short" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked><label for="shortAnswerOption" class="ml-2 block text-sm font-medium text-gray-700">Short</label></div>
                                <div class="flex items-center"><input id="longAnswerOption" type="radio" name="answerLength" value="long" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><label for="longAnswerOption" class="ml-2 block text-sm font-medium text-gray-700">Long</label></div>
                            </div>
                        </div>
                        <button id="getAnswerBtn" class="w-full mt-8 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">Get Answer</button>
                    </div>
                    <div id="resultContainer" class="mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8 hidden">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Solution</h2>
                        <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto my-4 hidden"></div>
                        <div id="answer" class="text-gray-700 leading-relaxed prose max-w-none"></div>
                    </div>
                    <div id="videoContainer" class="mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8 hidden">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Recommended Video</h2>
                        <div id="videoPlayerWrapper" class="video-container">
                            <iframe id="videoPlayer" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>
                    <div id="errorBox" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                        <strong class="font-bold">Error:</strong>
                        <span class="block sm:inline" id="errorMessage"></span>
                    </div>
                </main>
            </div>
            <footer class="text-center py-6 mt-8">
                <p class="text-sm text-gray-500">© 2025 Study Buddy. All rights reserved.</p>
            </footer>
        </div>

        <!-- USER PROFILE PAGE -->
        <div id="profilePage" class="page hidden p-4 sm:p-6 md:p-8">
             <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">User Profile</h2>
                    <button id="backToAppBtn" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition shadow-sm">Back to App</button>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                    <h3 class="text-xl font-semibold mb-4">Your Details</h3>
                    <div class="space-y-4">
                        <input id="profileName" type="text" placeholder="Your Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input id="profileEmail" type="email" placeholder="Your Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" disabled>
                        <button id="updateProfileBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md">Update Name</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                    <h3 class="text-xl font-semibold mb-4">Your Focus</h3>
                    <div class="flex items-center justify-between">
                        <p class="text-gray-700">Your current focus is: <strong id="currentUserFocus">Loading...</strong></p>
                        <button id="changeFocusBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">Change</button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-semibold mb-4">Your Past Questions</h3>
                    <div id="historyContainer" class="space-y-4 max-h-96 overflow-y-auto no-scrollbar">
                        <p class="text-gray-500">You haven't asked any questions yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXAM LIST PAGE -->
        <div id="examListPage" class="page hidden p-4 sm:p-6 md:p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Mock Exams</h2>
                    <button id="examBackToAppBtn" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition shadow-sm">Back to App</button>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                     <p class="text-gray-600 mb-4">Generate a mock exam based on your profile.</p>
                     <button id="generateExamBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Generate Auto Exam</button>
                     <p class="text-sm text-gray-400 mt-4">(Feature coming soon)</p>
                </div>
            </div>
        </div>

        <!-- QUIZ LIST PAGE (Updated) -->
        <div id="quizListPage" class="page hidden p-4 sm:p-6 md:p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Quizzes</h2>
                    <button id="quizBackToAppBtn" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition shadow-sm">Back to App</button>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                     <p class="text-gray-600 mb-4">Test your knowledge with a quick, auto-generated quiz based on your focus.</p>
                     <button id="generateQuizBtn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition">Generate 10-Min Quiz</button>
                </div>
            </div>
        </div>
        
        <!-- NEW: QUIZ TAKER PAGE -->
        <div id="quizTakerPage" class="page hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Quiz in Progress</h2>
                    <div class="text-lg font-semibold bg-red-500 text-white px-4 py-1 rounded-full">
                        <span id="quizTimer">10:00</span>
                    </div>
                </div>
                <div id="quizQuestionContainer" class="pt-4">
                    <p class="text-gray-500 text-sm">Question <span id="currentQuestionNumber">1</span> of <span id="totalQuizQuestions">5</span></p>
                    <p id="quizQuestionText" class="text-lg font-medium mt-2">Loading question...</p>
                    <textarea id="quizAnswerInput" class="w-full h-32 mt-4 p-3 border border-gray-300 rounded-lg" placeholder="Type your answer here..."></textarea>
                </div>
                <button id="nextQuestionBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700">Next Question</button>
            </div>
        </div>

        <!-- NEW: QUIZ RESULTS PAGE -->
        <div id="quizResultPage" class="page hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8 space-y-6 text-center">
                <h2 class="text-3xl font-bold text-gray-900">Quiz Complete!</h2>
                <p class="text-xl">Your Score: <span id="finalScore" class="font-bold text-green-600">0/5</span></p>
                <div id="quizReviewContainer" class="space-y-4 text-left max-h-96 overflow-y-auto no-scrollbar pt-4">
                    <!-- Review content will be added here -->
                </div>
                <button id="backToQuizzesBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700">Back to Quizzes</button>
            </div>
        </div>


        <!-- ADMIN DASHBOARD PAGE -->
        <div id="adminDashboardPage" class="page hidden p-4 sm:p-6 md:p-8">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Admin Dashboard</h2>
                    <div class="flex items-center space-x-4">
                        <button id="manageUsersBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition shadow-sm">Manage Users</button>
                        <button id="adminLogoutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition shadow-sm">Logout</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <p class="text-sm font-medium text-gray-500">Total Users</p>
                        <p id="totalUsersStat" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <p class="text-sm font-medium text-gray-500">Total Questions Asked</p>
                        <p id="totalQuestionsStat" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <p class="text-sm font-medium text-gray-500">Questions in Bank</p>
                        <p id="questionBankStat" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-semibold mb-4">Manage Announcements</h3>
                         <div id="announcementListAdmin" class="space-y-2 mb-4 max-h-48 overflow-y-auto no-scrollbar border rounded-lg p-2 bg-gray-50"></div>
                        <div class="flex space-x-2">
                             <input id="newAnnouncementInput" type="text" placeholder="Type announcement here..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                             <button id="addAnnouncementBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Post</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-semibold mb-4">Recently Added to Question Bank</h3>
                        <div id="adminHistoryContainer" class="space-y-4 max-h-96 overflow-y-auto no-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- USER MANAGEMENT PAGE -->
        <div id="userManagementPage" class="page hidden p-4 sm:p-6 md:p-8">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">User Management</h2>
                    <button id="backToAdminDashboardBtn" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition shadow-sm">Back to Dashboard</button>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-semibold mb-4">All Users</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Name</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Email</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Questions Asked</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDIT USER MODAL -->
        <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
             <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Edit User Details</h2>
                <div>
                    <label for="editUserName" class="block text-sm font-medium text-gray-700">User Name</label>
                    <input type="text" id="editUserName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="hidden" id="editUserId">
                </div>
                 <div class="flex justify-end space-x-4">
                    <button id="closeEditModalBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="saveUserChangesBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mt-6 mb-2">Question History</h3>
                    <div id="modalUserHistoryContainer" class="space-y-3 max-h-60 overflow-y-auto no-scrollbar border p-3 rounded-lg bg-gray-50"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, getDocs, onSnapshot, updateDoc, arrayUnion, deleteDoc, serverTimestamp, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAFBbsNLT4TdPT_ufuo6dYG_nqCCoVYEa0",
            authDomain: "cbse-4fbf5.firebaseapp.com",
            projectId: "cbse-4fbf5",
            storageBucket: "cbse-4fbf5.appspot.com",
            messagingSenderId: "81006126716",
            appId: "1:81006126716:web:7ec193f5f32424c3460bf9",
            measurementId: "G-FK9D0L8T75"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Element References ---
        const allPages = document.querySelectorAll('.page');
        const loginPage = document.getElementById('loginPage');
        const signupPage = document.getElementById('signupPage');
        const setupPage = document.getElementById('setupPage');
        const mainAppPage = document.getElementById('mainAppPage');
        const profilePage = document.getElementById('profilePage');
        const quizListPage = document.getElementById('quizListPage');
        const examListPage = document.getElementById('examListPage');
        const adminDashboardPage = document.getElementById('adminDashboardPage');
        const userManagementPage = document.getElementById('userManagementPage');
        const collegeCourseModal = document.getElementById('collegeCourseModal');
        const changeFocusBtn = document.getElementById('changeFocusBtn');
        const quizTakerPage = document.getElementById('quizTakerPage');
        const quizResultPage = document.getElementById('quizResultPage');
        
        const getAnswerBtn = document.getElementById('getAnswerBtn');
        const questionScanner = document.getElementById('questionScanner');
        const resultContainer = document.getElementById('resultContainer');
        const loader = document.getElementById('loader');
        const answerDiv = document.getElementById('answer');
        const fileText = document.getElementById('file-text');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const scanTab = document.getElementById('scanTab');
        const typeTab = document.getElementById('typeTab');
        const scanContent = document.getElementById('scanContent');
        const typeContent = document.getElementById('typeContent');
        const manualQuestion = document.getElementById('manualQuestion');
        const videoContainer = document.getElementById('videoContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const openCameraBtn = document.getElementById('openCameraBtn');
        const cameraModal = document.getElementById('cameraModal');
        const cameraView = document.getElementById('cameraView');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');

        let stream;
        let base64ImageData = null;
        let activeTab = 'scan';
        let quizTimerInterval;

        const toast = document.getElementById('toast');
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = '';
            toast.classList.add('show', type);
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        const showPage = (pageToShow) => {
            allPages.forEach(page => page.classList.add('hidden'));
            pageToShow.classList.remove('hidden');
        };

        document.getElementById('showSignup').addEventListener('click', (e) => { e.preventDefault(); showPage(signupPage); });
        document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); showPage(loginPage); });
        document.getElementById('profileBtn').addEventListener('click', () => { showPage(profilePage); loadUserProfile(); });
        document.getElementById('backToAppBtn').addEventListener('click', () => showPage(mainAppPage));
        document.getElementById('quizNavBtn').addEventListener('click', () => showPage(quizListPage));
        document.getElementById('quizBackToAppBtn').addEventListener('click', () => showPage(mainAppPage));
        document.getElementById('examNavBtn').addEventListener('click', () => showPage(examListPage)); 
        document.getElementById('examBackToAppBtn').addEventListener('click', () => showPage(mainAppPage)); 
        document.getElementById('manageUsersBtn').addEventListener('click', () => { showPage(userManagementPage); loadUsersForManagement(); });
        document.getElementById('backToAdminDashboardBtn').addEventListener('click', () => showPage(adminDashboardPage));
        document.getElementById('backToQuizzesBtn').addEventListener('click', () => showPage(quizListPage));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.email === 'admin@admin.com') {
                    showPage(adminDashboardPage);
                    loadAdminDashboard();
                } else {
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().grade) {
                        showPage(mainAppPage);
                        loadAnnouncementsForUser();
                    } else {
                        document.getElementById('setupUserName').textContent = user.displayName || "there";
                        showPage(setupPage);
                    }
                }
            } else {
                showPage(loginPage);
            }
        });

        document.getElementById('signupBtn').addEventListener('click', async () => {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            if (!name || !email || !password) { showToast("Please fill in all fields.", "error"); return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: name });
                await setDoc(doc(db, "users", user.uid), { name: name, email: email, history: [] });
            } catch (error) { showToast(error.message, "error"); }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
             const email = document.getElementById('loginEmail').value;
             const password = document.getElementById('loginPassword').value;
             if (email === 'admin' && password === 'admin@123') {
                try { await signInWithEmailAndPassword(auth, 'admin@admin.com', 'admin@123'); } 
                catch (error) { showToast("Admin account not found in Firebase.", "error"); }
                return;
             }
             try { await signInWithEmailAndPassword(auth, email, password); } 
             catch (error) { showToast(error.message, "error"); }
        });
        
        async function saveUserSetup(grade, targetExam) {
            const user = auth.currentUser;
            if (!user) return;
            const userDocRef = doc(db, "users", user.uid);
            try {
                await setDoc(userDocRef, { grade, targetExam }, { merge: true });
                showPage(mainAppPage);
                loadAnnouncementsForUser();
            } catch (error) { showToast("Could not save preferences: " + error.message, "error"); }
        }

        document.getElementById('schoolCard').addEventListener('click', () => saveUserSetup('School (10-12)', 'School Exams'));
        document.getElementById('examCard').addEventListener('click', () => saveUserSetup('Competitive Exams', 'JEE/NEET'));
        document.getElementById('collegeCard').addEventListener('click', () => collegeCourseModal.classList.remove('hidden'));
        document.getElementById('courseSelectionContainer').addEventListener('click', (e) => {
            if (e.target.classList.contains('course-btn')) {
                const course = e.target.dataset.course;
                saveUserSetup('College', course);
                collegeCourseModal.classList.add('hidden');
            }
        });

        const performLogout = async () => {
            try { await signOut(auth); } 
            catch (error) { showToast(error.message, "error"); }
        };
        document.getElementById('logoutBtn').addEventListener('click', performLogout);
        document.getElementById('adminLogoutBtn').addEventListener('click', performLogout);
        
        function loadAdminDashboard() {
            onSnapshot(collection(db, "users"), (snap) => { document.getElementById('totalUsersStat').textContent = snap.size; });
            onSnapshot(collection(db, "questions"), (snap) => { document.getElementById('totalQuestionsStat').textContent = snap.size; });
            onSnapshot(collection(db, "questionBank"), (snap) => { document.getElementById('questionBankStat').textContent = snap.size; });
            loadAnnouncementsForAdmin();
            onSnapshot(query(collection(db, "questionBank"), orderBy("timestamp", "desc"), limit(10)), (snapshot) => {
                const adminHistoryContainer = document.getElementById('adminHistoryContainer');
                adminHistoryContainer.innerHTML = '';
                if (snapshot.empty) { adminHistoryContainer.innerHTML = '<p class="text-gray-500">No questions in bank.</p>'; return; }
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const historyItem = document.createElement('div');
                    historyItem.className = 'p-4 border rounded-lg bg-gray-50';
                    historyItem.innerHTML = `<p class="font-semibold text-gray-800">${item.question}</p><p class="text-sm text-gray-500 mt-1">Topic: <strong>${item.topic}</strong></p>`;
                    adminHistoryContainer.appendChild(historyItem);
                });
            });
        }

        function loadAnnouncementsForAdmin() {
            const listDiv = document.getElementById('announcementListAdmin');
            const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                listDiv.innerHTML = '';
                if (snapshot.empty) { listDiv.innerHTML = '<p class="text-gray-400">No announcements.</p>'; return; }
                snapshot.forEach(doc => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                    item.innerHTML = `<span class="text-sm">${doc.data().message}</span><button data-id="${doc.id}" class="delete-announcement-btn font-bold text-red-500 hover:text-red-700">X</button>`;
                    listDiv.appendChild(item);
                });
            });
        }
        document.getElementById('addAnnouncementBtn').addEventListener('click', async () => {
            const input = document.getElementById('newAnnouncementInput');
            if (input.value.trim() === '') return;
            await addDoc(collection(db, "announcements"), { message: input.value.trim(), timestamp: serverTimestamp() });
            input.value = '';
        });
        document.getElementById('announcementListAdmin').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-announcement-btn')) {
                await deleteDoc(doc(db, "announcements", e.target.dataset.id));
                showToast("Announcement removed.");
            }
        });

        async function loadAnnouncementsForUser() {
            const container = document.getElementById('announcementsContainer');
            const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            container.innerHTML = '';
            querySnapshot.forEach(doc => {
                const announcementDiv = document.createElement('div');
                announcementDiv.className = 'bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg shadow';
                announcementDiv.innerHTML = `<p class="font-bold">Announcement</p><p>${doc.data().message}</p>`;
                container.appendChild(announcementDiv);
            });
        }
        
        async function loadUserProfile() {
            const user = auth.currentUser;
            if (!user) return;
            document.getElementById('profileName').value = user.displayName || '';
            document.getElementById('profileEmail').value = user.email || '';
            const userDocRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const userData = docSnap.data();
                const currentUserFocus = document.getElementById('currentUserFocus');
                if (userData.grade && userData.targetExam) {
                    currentUserFocus.textContent = `${userData.grade} - ${userData.targetExam}`;
                } else {
                    currentUserFocus.textContent = 'Not set';
                }
                const historyContainer = document.getElementById('historyContainer');
                historyContainer.innerHTML = '';
                if (userData.history && userData.history.length > 0) {
                    [...userData.history].reverse().forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'p-4 border rounded-lg bg-gray-50';
                        historyItem.innerHTML = `<p class="font-semibold text-gray-800">${item.question}</p><p class="text-sm text-gray-600 mt-2">${item.answer.substring(0, 150)}...</p><p class="text-xs text-gray-400 mt-2">${new Date(item.timestamp).toLocaleString()}</p>`;
                        historyContainer.appendChild(historyItem);
                    });
                } else {
                    historyContainer.innerHTML = '<p class="text-gray-500">You haven\'t asked any questions yet.</p>';
                }
            }
        }

        changeFocusBtn.addEventListener('click', () => {
            showPage(setupPage);
        });

        document.getElementById('updateProfileBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            const newName = document.getElementById('profileName').value;
            if (!user || !newName) return;
            try {
                await updateProfile(user, { displayName: newName });
                await updateDoc(doc(db, "users", user.uid), { name: newName });
                showToast("Profile updated successfully!");
            } catch (error) {
                showToast("Failed to update profile: " + error.message, "error");
            }
        });

        document.getElementById('openCameraBtn').addEventListener('click', async () => {
            cameraModal.classList.remove('hidden');
            cameraModal.classList.add('flex');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraView.srcObject = stream;
            } catch (err) {
                showError("Could not access the camera.");
                closeCamera();
            }
        });
        document.getElementById('closeCameraBtn').addEventListener('click', () => closeCamera());
        function closeCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); }
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
        }
        document.getElementById('captureBtn').addEventListener('click', () => {
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraView.videoWidth;
            cameraCanvas.height = cameraView.videoHeight;
            context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);
            base64ImageData = cameraCanvas.toDataURL('image/jpeg').split(',')[1];
            fileText.textContent = 'Image captured from camera.';
            closeCamera();
        });

        scanTab.addEventListener('click', () => {
            activeTab = 'scan';
            scanTab.classList.add('text-blue-600', 'border-blue-600');
            scanTab.classList.remove('text-gray-500');
            typeTab.classList.remove('text-blue-600', 'border-blue-600');
            typeTab.classList.add('text-gray-500');
            scanContent.classList.remove('hidden');
            typeContent.classList.add('hidden');
        });
        typeTab.addEventListener('click', () => {
            activeTab = 'type';
            typeTab.classList.add('text-blue-600', 'border-blue-600');
            typeTab.classList.remove('text-gray-500');
            scanTab.classList.remove('text-blue-600', 'border-blue-600');
            scanTab.classList.add('text-gray-500');
            typeContent.classList.remove('hidden');
            scanContent.classList.add('hidden');
        });
        questionScanner.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileText.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => { base64ImageData = e.target.result.split(',')[1]; };
                reader.readAsDataURL(file);
            } else {
                fileText.textContent = 'Click to upload an image';
                base64ImageData = null;
            }
        });

        getAnswerBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            answerDiv.innerHTML = '';
            resultContainer.classList.remove('hidden');
            videoContainer.classList.add('hidden');
            loader.classList.remove('hidden');
            getAnswerBtn.disabled = true;
            getAnswerBtn.textContent = 'Fetching Solution...';
            hideError();

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || !userDoc.data().targetExam) {
                showError("Please set your focus in your profile before asking a question.");
                resetButtonState();
                return;
            }
            const userFocus = `${userDoc.data().grade} - ${userDoc.data().targetExam}`;

            try {
                const answerLength = document.querySelector('input[name="answerLength"]:checked').value;
                const promptInstruction = `You are an expert academic tutor for an Indian student whose focus is ${userFocus}. Your task is to answer the following question. First, determine if the question is a valid, on-topic academic question relevant to this focus.
                - If it is relevant, provide a ${answerLength}, simple, step-by-step solution.
                - If the question is NOT a valid academic question (e.g., it's a joke, nonsense, or asks 'why Kattappa killed Baahubali'), you MUST respond with ONLY this exact text: 'This does not seem to be a valid academic question. Please ask a question related to your studies.'
                After providing a valid solution, on a new line, write "VIDEO_URL:" followed by a single, relevant YouTube video URL.`;
                
                let userQuestion, prompt;
                if (activeTab === 'scan') {
                    if (!base64ImageData) { showError("Please upload or capture an image."); resetButtonState(); return; }
                    userQuestion = "Question from image";
                    prompt = `Analyze the image. Then, follow these instructions: ${promptInstruction}`;
                    await getSolution(prompt, base64ImageData, userQuestion, userFocus);
                } else {
                    const questionText = manualQuestion.value.trim();
                    if (!questionText) { showError("Please type your question."); resetButtonState(); return; }
                    userQuestion = questionText;
                    prompt = `The user's question is: "${questionText}". Now, follow these instructions: ${promptInstruction}`;
                    await getSolution(prompt, null, userQuestion, userFocus);
                }
            } catch (error) {
                showError('Failed to fetch the solution.');
            } finally {
                resetButtonState();
            }
        });

        async function getSolution(prompt, imageData = null, userQuestion, topic) {
            const apiKey =  "AIzaSyAVUM1iSxjffw7RgbEli0pOzMXTVqbxdRA";
            const finalApiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : apiKey;
            if (!finalApiKey) { showError("API Key is missing."); return; }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${finalApiKey}`;
            const parts = [{ text: prompt }];
            if (imageData) { parts.push({ inlineData: { mimeType: "image/jpeg", data: imageData } }); }
            const payload = { contents: [{ parts }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error.message); }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0]) {
                    const fullResponseText = result.candidates[0].content.parts[0].text;
                    let solutionText = fullResponseText, videoUrl = null;
                    if (fullResponseText.includes("VIDEO_URL:")) {
                        [solutionText, videoUrl] = fullResponseText.split("VIDEO_URL:").map(s => s.trim());
                    }
                    answerDiv.innerHTML = solutionText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```(.*?)```/gs, '<pre class="bg-gray-100 p-3 rounded-md"><code>$1</code></pre>').replace(/\n/g, '<br>');
                    if (videoUrl) { displayVideo(videoUrl); }
                    await logQuestion(userQuestion, solutionText, topic);
                } else {
                    answerDiv.textContent = 'Could not generate a solution.';
                }
            } catch (error) {
                showError(error.message || "Issue connecting to the AI service.");
            }
        }

        async function logQuestion(question, answer, topic) {
            const user = auth.currentUser;
            if (!user) return;
            const logEntry = { question, answer, timestamp: Date.now(), userId: user.uid, userEmail: user.email, userName: user.displayName || 'Unknown', topic };
            
            await updateDoc(doc(db, "users", user.uid), { history: arrayUnion({ question, answer, timestamp: logEntry.timestamp }) });

            if (!answer.includes("not seem to be a valid academic question")) {
                 await addDoc(collection(db, "questionBank"), logEntry);
            }
        }
        
        function displayVideo(url) {
            let videoId = null;
            try {
                const urlObj = new URL(url);
                videoId = (urlObj.hostname === 'youtu.be') ? urlObj.pathname.substring(1) : urlObj.searchParams.get('v');
            } catch (e) { return; }
            if (videoId) {
                videoPlayer.src = `https://www.youtube.com/embed/${videoId}`;
                videoContainer.classList.remove('hidden');
            }
        }
        
        function resetButtonState() {
            loader.classList.add('hidden');
            getAnswerBtn.disabled = false;
            getAnswerBtn.textContent = 'Get Answer';
        }
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            videoContainer.classList.add('hidden');
        }
        function hideError() { errorBox.classList.add('hidden'); }

        document.getElementById('generateQuizBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if(!user) return;

            const userDocRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userDocRef);

            if(!docSnap.exists() || !docSnap.data().targetExam) {
                showToast("Please set your focus in your profile first.", "error");
                return;
            }
            const userFocus = `${docSnap.data().grade} - ${docSnap.data().targetExam}`;
            
            const q = query(collection(db, "questionBank"), where("topic", "==", userFocus), limit(5));
            const snapshot = await getDocs(q);
            
            if(snapshot.docs.length < 5) {
                showToast("Not enough questions in the bank for your focus area yet. Ask more questions to build it up!", "error");
                return;
            }

            const quizQuestions = snapshot.docs.map(doc => doc.data());
            startQuiz(quizQuestions);
        });

        function startQuiz(questions) {
            let currentQuestionIndex = 0;
            let score = 0;
            let userAnswers = [];

            showPage(quizTakerPage);
            
            function displayQuestion() {
                document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex + 1;
                document.getElementById('totalQuizQuestions').textContent = questions.length;
                document.getElementById('quizQuestionText').innerHTML = questions[currentQuestionIndex].question.replace(/\n/g, '<br>');
                document.getElementById('quizAnswerInput').value = '';
                document.getElementById('nextQuestionBtn').textContent = currentQuestionIndex === questions.length - 1 ? "Finish Quiz" : "Next Question";
            }

            function finishQuiz() {
                clearInterval(quizTimerInterval);
                document.getElementById('finalScore').textContent = `${score}/${questions.length}`;
                const reviewContainer = document.getElementById('quizReviewContainer');
                reviewContainer.innerHTML = '';

                questions.forEach((q, index) => {
                    const isCorrect = userAnswers[index] && userAnswers[index].toLowerCase() === q.answer.toLowerCase();
                    reviewContainer.innerHTML += `
                        <div class="p-4 border rounded-lg ${isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                            <p class="font-semibold">${q.question}</p>
                            <p class="text-sm mt-2">Your Answer: ${userAnswers[index] || 'No answer'}</p>
                            <p class="text-sm mt-1">Correct Answer: ${q.answer}</p>
                        </div>
                    `;
                });
                showPage(quizResultPage);
            }

            document.getElementById('nextQuestionBtn').onclick = () => {
                const userAnswer = document.getElementById('quizAnswerInput').value.trim();
                userAnswers.push(userAnswer);
                if(userAnswer.toLowerCase() === questions[currentQuestionIndex].answer.toLowerCase()) {
                    score++;
                }

                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    displayQuestion();
                } else {
                    finishQuiz();
                }
            };

            let timeLeft = 600; 
            quizTimerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('quizTimer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeLeft <= 0) {
                    finishQuiz();
                }
            }, 1000);

            displayQuestion();
        }


        async function loadUsersForManagement() {
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>';
            const snapshot = await getDocs(collection(db, "users"));
            if (snapshot.empty) { usersTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No users found.</td></tr>'; return; }
            usersTableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const userData = doc.data();
                const questionsCount = userData.history ? userData.history.length : 0;
                const row = usersTableBody.insertRow();
                row.className = 'border-b';
                row.innerHTML = `<td class="py-3 px-4">${userData.name || 'N/A'}</td><td class="py-3 px-4">${userData.email}</td><td class="py-3 px-4">${questionsCount}</td><td class="py-3 px-4"><button class="edit-btn bg-blue-100 text-blue-700 text-xs font-semibold mr-2 px-2.5 py-1 rounded-full" data-id="${doc.id}">Edit</button><button class="delete-btn bg-red-100 text-red-700 text-xs font-semibold px-2.5 py-1 rounded-full" data-id="${doc.id}">Delete</button></td>`;
            });
        }

        document.getElementById('usersTableBody').addEventListener('click', async (e) => {
            const userId = e.target.dataset.id;
            if (!userId) return;
            if (e.target.classList.contains('edit-btn')) { openEditModal(userId); } 
            else if (e.target.classList.contains('delete-btn')) { deleteUser(userId); }
        });

        async function openEditModal(userId) {
            const docSnap = await getDoc(doc(db, "users", userId));
            if (!docSnap.exists()) { showToast("User not found!", "error"); return; }
            const userData = docSnap.data();
            document.getElementById('editUserName').value = userData.name;
            document.getElementById('editUserId').value = userId;
            const modalHistory = document.getElementById('modalUserHistoryContainer');
            modalHistory.innerHTML = '';
            if (userData.history && userData.history.length > 0) {
                 [...userData.history].reverse().forEach(item => {
                    modalHistory.innerHTML += `<div class="p-2 border-b"><p class="font-medium text-sm">${item.question}</p><p class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleString()}</p></div>`;
                 });
            } else {
                modalHistory.innerHTML = '<p class="text-gray-500">No questions asked.</p>';
            }
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        document.getElementById('closeEditModalBtn').addEventListener('click', () => document.getElementById('editUserModal').classList.add('hidden'));

        document.getElementById('saveUserChangesBtn').addEventListener('click', async () => {
            const userId = document.getElementById('editUserId').value;
            const newName = document.getElementById('editUserName').value.trim();
            if (!userId || !newName) { showToast("Name cannot be empty.", "error"); return; }
            try {
                await updateDoc(doc(db, "users", userId), { name: newName });
                showToast("User updated successfully!");
                document.getElementById('editUserModal').classList.add('hidden');
                loadUsersForManagement();
            } catch (error) { showToast("Failed to update user.", "error"); }
        });

        async function deleteUser(userId) {
            try {
                await deleteDoc(doc(db, "users", userId));
                showToast("User data deleted.");
                loadUsersForManagement();
            } catch (error) { showToast("Failed to delete user data.", "error"); }
        }

    </script>

</body>
</html>
